<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        .box {
            margin-left: 20px;
            margin-top: 20px;
        }

        .box .game-box {
            width: 400px;
            height: 400px;
            border: 2px solid blue;
            margin-top: 50px;
            position: relative;
            overflow: hidden;
        }

        .box .game-box .game {
            position: absolute;
            left: 0;
            top: -50px;
        }

        .box .game-box .game .row {
            display: flex;
        }

        .box .game-box .game .row .ceil {
            width: 100px;
            height: 100px;
            border: 1px solid #8a8a8a;
            /* 改变盒子模型 */
            box-sizing: border-box;
            background: white;
        }

        .box .game-box .game .row .ceil.black {
            background: black;
        }
    </style>
</head>

<body>
    <div class="box">
        <!-- 分数 -->
        <input type="text" id="scoreInput" value="0" disabled />

        <!-- 游戏区域容器 -->
        <div class="game-box">
            <!-- 游戏区域 -->
            <div class="game">
                <!-- 行 -->
                <div class="row">
                    <!-- 列 -->
                    <div class="ceil black"></div>
                    <div class="ceil"></div>
                    <div class="ceil"></div>
                    <div class="ceil"></div>
                </div>

                <!-- 行 -->
                <div class="row">
                    <!-- 列 -->
                    <div class="ceil"></div>
                    <div class="ceil black"></div>
                    <div class="ceil"></div>
                    <div class="ceil"></div>
                </div>

                <!-- 行 -->
                <div class="row">
                    <!-- 列 -->
                    <div class="ceil"></div>
                    <div class="ceil"></div>
                    <div class="ceil black"></div>
                    <div class="ceil"></div>
                </div>

                <!-- 行 -->
                <div class="row">
                    <!-- 列 -->
                    <div class="ceil"></div>
                    <div class="ceil"></div>
                    <div class="ceil"></div>
                    <div class="ceil black"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // 面向对象的思想就是找对象做事情  不同对象做的事情不一样
        // 对象就拥有方法和属性

        // 工具对象( 获取DOM对象方法, 获取计算以后样式属性值的方法, 随机方法)
        function Tool() {
            // 如果有属性,我们就写属性
        }
        // 获取dom对象的方法
        Tool.prototype.$ = function (cssSelector) {
            var dom = document.querySelectorAll(cssSelector);
            if (dom.length === 0) {
                return null;
            }
            if (dom.length === 1) {
                return dom[0];
            }
            return dom;
        }

        // 获取计算后样式属性值的方法
        Tool.prototype.getStyle = function (dom, attr) {
            return window.getComputedStyle(dom)[attr];
        }

        // 封装一个随机数方法
        Tool.prototype.getRandom = function (min, max) {
            return Math.floor(Math.random() * (max - min + 1) + min);
        }

        // 再写一个Game游戏对象
        function Game() {
            // 添加属性
            // 实例化tool对象
            this.tool = new Tool();
            // 获取相关dom对象
            this.game = this.tool.$(".game");
            this.scoreInput = this.tool.$("#scoreInput");
            // 下落速度
            this.speed = 1;
            // 默认分数
            this.scoreVal = 0;
            // 定时器标识符
            this.timerInterval;
            // 定义一个变量,保存当前游戏状态isGameOver  false表示游戏未结束  true表示游戏结束  
            this.isGameOver = false;
        }

        // 通过Game原型添加方法
        // 创建一行的方法
        Game.prototype.createRow = function () {
            // 4.随机创建黑块
            // 4.1 随机得到 1 , 2, 3, 4之间的一个数
            // 4.2 如果当前的i等于我们的随机整数,我们就添加.black类,那么就是黑块

            // 创建新的一行
            var row = document.createElement("div");
            // 设置行的类名
            row.className = "row";
            // 随机得到一个1~4之间随机整数
            var randomNum = this.tool.getRandom(1, 4);
            // 创建四个列,并且添加到行中
            for (var i = 1; i <= 4; i++) {
                // 创建新的一列
                var ceil = document.createElement("div");
                // 判断randomNum的值是否等于i
                if (randomNum === i) {
                    // 设置行的类名
                    ceil.className = "ceil black";
                } else {
                    // 设置行的类名
                    ceil.className = "ceil";
                }
                // 把列添加到行中
                row.appendChild(ceil);
            }
            // 把新创建的行添加到游戏区域的最前面
            this.game.insertBefore(row, this.game.firstElementChild);
            // 设置游戏区域的top值
            this.game.style.top = -100 + "px";
        }

        // 删除多余行的方法
        Game.prototype.removeRow = function () {
            // 5.删除底部多余的行 如果游戏区中行数大于5,我们就删除最后一行
            // console.log(game.children);
            if (this.game.children.length > 5) {
                this.game.lastElementChild.remove();
            }
        }

        // 触底是否游戏结束的方法
        Game.prototype.isTouchBottom = function () {
            // 9.运动到底部判断最后一行是否全部黑块被点击
            // 9.1 如果当前行的黑块被成功点击,我们就给这行添加一个自定义属性pass,并且赋值为true
            // 9.2 当game的top大于等于0的时候,代表移动到底部了
            // 9.3 判断游戏区最后一行上黑块是否已经被点击,如果是则清除定时器,设置游戏状态为结束,并且弹窗提示用户,最后加上一个return终止函数体后续的代码执行
            // 判断游戏区域触底
            // console.log("游戏区域碰到底部了");
            // game.lastElementChild.style.border = "5px solid pink";

            // 游戏区域碰到底部以后,最后一行的黑块是否已经被消灭了
            for (var j = 0; j < this.game.lastElementChild.children.length; j++) {
                if (this.game.lastElementChild.children[j].classList.contains("black")) {
                    // 清除定时器
                    window.clearInterval(this.timerInterval);
                    // 修改游戏状态为结束
                    this.isGameOver = true;
                    // 提示信息
                    alert("游戏结束11111");
                }
            }
        }

        // 给游戏区域绑定点击事件的方法
        Game.prototype.gameBindClick = function () {
            // 6.绑定点击事件 在事件中进行判断 点击的是黑块还是白块;如果是黑块就加分变白,白块就游戏结束;
            // 6.1 如果点击的是黑块就加1分,黑块变白
            // 6.2 获取分数对象文本框
            // 6.3 定义一个保存分数的全局变量
            // 6.4 如果点击的白块就弹窗提示游戏结束 清除定时器


            // 7.游戏结束后的判断和处理
            // 7.1 游戏结束了,此时黑白块都应该是不允许点击的了,而且点击黑块以后也不能加分
            // 7.2 定义一个全局变量保存游戏是否结束
            // 7.3 在判断点击黑白块之前,需要先判断游戏是否已经结束,如果结束了我们就弹窗提示用户游戏已经结束
            // 7.4 如果点击的白块,除了清除定时器,还需要修改gameover的值为true

            // 8.根据分数游戏加速(为了让游戏更有趣味性)
            // 8.1 定义一个全局变量speed保存游戏区下落的速度
            // 8.2 判断全局变量分数是否是5的倍数(我们假设每多5分,就增加一次难度)
            // 8.3 在用户成功点击黑块以后,加完分之后,我们就判断当前分数是否为是5的倍数,如果是我们就增加下落的速度

            // 使用事件委托绑定的
            this.game.onclick = function (e) {
                if (this.isGameOver) { // 游戏已经结束
                    alert("游戏已经结束");
                } else { // 游戏未结束
                    // 如果点击的列
                    if (e.target.classList.contains("ceil")) {
                        if (e.target.classList.contains("black")) { // 如果点击的黑块
                            // 黑块变白
                            e.target.classList.remove("black");
                            // 加分
                            this.scoreVal++;
                            // 设置文本框的value值
                            this.scoreInput.value = this.scoreVal;
                            // 每增加5分, 加快下落速度
                            if (this.scoreVal % 5 == 0) {
                                // 增加速度
                                this.speed += 1;
                            }
                        } else { // 如果点击的是白块
                            // 提示信息
                            alert("点击到了白块,游戏结束");
                            // 清除定时器
                            window.clearInterval(this.timerInterval);
                            // 修改游戏状态为结束
                            this.isGameOver = true;
                        }
                    }
                }
            }.bind(this);
        }

        // 初始化游戏的方法
        Game.prototype.init = function () {
            // 别踩白块-面向过程实现
            // 思路:
            // 1.创建页面文件,写静态游戏可视区域和游戏的4x4 div的游戏区域
            // 2.让div游戏区 动起来 向下运动(不断增加游戏区域的top值,让游戏动起来)

            // 开启定时器
            this.timerInterval = window.setInterval(function () {
                // 获取当前的top属性值
                var curTop = parseFloat(this.tool.getStyle(this.game, "top"));

                // 设置.game的top值
                this.game.style.top = curTop + this.speed + "px";

                // 判断当前的top属性值是否大于等于0
                if (curTop >= 0) {
                    // 3.动态添加一行
                    // 3.1 什么时候添加一行? 当游戏区的top大于等于0的时候
                    // 3.2 如何动态创建一行 document.createElement
                    // 3.3 每行中有4个div格子
                    // 3.4 把动态创建好的行,添加到游戏区的最前面
                    // 3.5 重新将游戏区的top值设置-100px
                    // 调用创建一行的函数
                    this.createRow();
                    // 调用删除多余行的函数
                    this.removeRow();
                    // 调用触底是否游戏结束的函数
                    this.isTouchBottom();
                }
            }.bind(this), 20);

            // 调用游戏区域绑定点击事件的函数
            this.gameBindClick();
        }

        // 实例化Game对象
        var g = new Game();
        g.init();
    </script>
</body>

</html>